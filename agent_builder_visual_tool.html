<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¬ Agent Builder Visual Tool - Ù¾ÛŒØ³Ø§Ù† ÙˆØ¨</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/konva@9.2.0/konva.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .node-card {
            transition: all 0.3s ease;
            cursor: grab;
            user-select: none;
        }
        .node-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .node-card:active {
            cursor: grabbing;
        }
        .workflow-canvas {
            background: 
                radial-gradient(circle at 20px 20px, #e5e7eb 1px, transparent 1px),
                radial-gradient(circle at 40px 40px, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .connection-line {
            stroke: #3b82f6;
            stroke-width: 3;
            fill: none;
            marker-end: url(#arrowhead);
        }
        .node-input {
            background: #10b981;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        .node-output {
            background: #ef4444;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-4 sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="floating">
                        <i class="fas fa-robot text-3xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">ğŸ§¬ Agent Builder Visual Tool</h1>
                        <p class="text-blue-100">Ø³Ø§Ø®Øª AI Agent Ù‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø¯ÙˆÙ† Ú©Ø¯Ù†ÙˆÛŒØ³ÛŒ</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button id="saveAgent" class="glass-effect hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-save"></i>
                        Ø°Ø®ÛŒØ±Ù‡ Agent
                    </button>
                    <button id="runAgent" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-play"></i>
                        Ø§Ø¬Ø±Ø§
                    </button>
                    <button id="testAgent" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-vial"></i>
                        ØªØ³Øª
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex h-screen pt-16">
        <!-- Sidebar - Node Library -->
        <div class="w-80 bg-white shadow-lg overflow-y-auto">
            <div class="p-4 border-b">
                <h2 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-puzzle-piece text-blue-500"></i>
                    Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Node Ù‡Ø§
                </h2>
            </div>
            
            <!-- Node Categories -->
            <div class="p-4">
                <!-- Input Nodes -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-3 flex items-center">
                        <i class="fas fa-sign-in-alt text-green-500 ml-2"></i>
                        ÙˆØ±ÙˆØ¯ÛŒ (Input)
                    </h3>
                    <div class="space-y-2">
                        <div class="node-card bg-green-50 border border-green-200 rounded-lg p-3" draggable="true" data-node-type="text-input">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-keyboard text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">ÙˆØ±ÙˆØ¯ÛŒ Ù…ØªÙ†</h4>
                                    <p class="text-xs text-gray-600">Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø§Ø² Ú©Ø§Ø±Ø¨Ø±</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-green-50 border border-green-200 rounded-lg p-3" draggable="true" data-node-type="voice-input">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-microphone text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">ÙˆØ±ÙˆØ¯ÛŒ ØµØ¯Ø§</h4>
                                    <p class="text-xs text-gray-600">ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø±</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-green-50 border border-green-200 rounded-lg p-3" draggable="true" data-node-type="file-input">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-file text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">ÙˆØ±ÙˆØ¯ÛŒ ÙØ§ÛŒÙ„</h4>
                                    <p class="text-xs text-gray-600">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Processing Nodes -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-3 flex items-center">
                        <i class="fas fa-brain text-purple-500 ml-2"></i>
                        Ù¾Ø±Ø¯Ø§Ø²Ø´ AI
                    </h3>
                    <div class="space-y-2">
                        <div class="node-card bg-purple-50 border border-purple-200 rounded-lg p-3" draggable="true" data-node-type="gpt-processor">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">GPT Processor</h4>
                                    <p class="text-xs text-gray-600">Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ GPT-4</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-purple-50 border border-purple-200 rounded-lg p-3" draggable="true" data-node-type="claude-processor">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-brain text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Claude Processor</h4>
                                    <p class="text-xs text-gray-600">Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Claude</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-purple-50 border border-purple-200 rounded-lg p-3" draggable="true" data-node-type="image-processor">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-image text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±</h4>
                                    <p class="text-xs text-gray-600">ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ± Ø¨Ø§ AI</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Nodes -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-3 flex items-center">
                        <i class="fas fa-bolt text-orange-500 ml-2"></i>
                        Ø¹Ù…Ù„ÛŒØ§Øª (Actions)
                    </h3>
                    <div class="space-y-2">
                        <div class="node-card bg-orange-50 border border-orange-200 rounded-lg p-3" draggable="true" data-node-type="api-call">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-globe text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API</h4>
                                    <p class="text-xs text-gray-600">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª HTTP</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-orange-50 border border-orange-200 rounded-lg p-3" draggable="true" data-node-type="database-save">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-database text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³</h4>
                                    <p class="text-xs text-gray-600">Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-orange-50 border border-orange-200 rounded-lg p-3" draggable="true" data-node-type="email-send">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-envelope text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„</h4>
                                    <p class="text-xs text-gray-600">Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯Ú©Ø§Ø±</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Decision Nodes -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-3 flex items-center">
                        <i class="fas fa-code-branch text-blue-500 ml-2"></i>
                        ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ
                    </h3>
                    <div class="space-y-2">
                        <div class="node-card bg-blue-50 border border-blue-200 rounded-lg p-3" draggable="true" data-node-type="condition">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-question text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Ø´Ø±Ø·</h4>
                                    <p class="text-xs text-gray-600">Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø·</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-blue-50 border border-blue-200 rounded-lg p-3" draggable="true" data-node-type="switch">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-random text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Ø³ÙˆØ¦ÛŒÚ†</h4>
                                    <p class="text-xs text-gray-600">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø³ÛŒØ±</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Output Nodes -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-600 mb-3 flex items-center">
                        <i class="fas fa-sign-out-alt text-red-500 ml-2"></i>
                        Ø®Ø±ÙˆØ¬ÛŒ (Output)
                    </h3>
                    <div class="space-y-2">
                        <div class="node-card bg-red-50 border border-red-200 rounded-lg p-3" draggable="true" data-node-type="text-output">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-comment text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Ø®Ø±ÙˆØ¬ÛŒ Ù…ØªÙ†</h4>
                                    <p class="text-xs text-gray-600">Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ†</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-card bg-red-50 border border-red-200 rounded-lg p-3" draggable="true" data-node-type="notification">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center ml-3">
                                    <i class="fas fa-bell text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-sm">Ø§Ø¹Ù„Ø§Ù†</h4>
                                    <p class="text-xs text-gray-600">Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù†</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="flex-1 flex flex-col">
            <!-- Toolbar -->
            <div class="bg-white border-b p-4 flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button id="zoomIn" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button id="zoomOut" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button id="centerView" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                    <div class="w-px h-6 bg-gray-300"></div>
                    <button id="undo" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button id="redo" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span class="text-sm text-gray-600">Agent: <span id="agentName">Untitled Agent</span></span>
                    <button id="renameAgent" class="text-blue-500 hover:text-blue-700">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>

            <!-- Canvas -->
            <div class="flex-1 relative">
                <div id="workflowCanvas" class="workflow-canvas w-full h-full relative overflow-hidden">
                    <!-- Konva.js canvas will be rendered here -->
                </div>
                
                <!-- Connection Lines SVG -->
                <svg id="connectionLines" class="absolute inset-0 pointer-events-none" style="z-index: 1;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" />
                        </marker>
                    </defs>
                </svg>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="w-80 bg-white shadow-lg border-r overflow-y-auto">
            <div class="p-4 border-b">
                <h2 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-cog text-gray-500"></i>
                    ØªÙ†Ø¸ÛŒÙ…Ø§Øª Node
                </h2>
            </div>
            <div id="nodeProperties" class="p-4">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                    <p>Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ Ø±ÙˆÛŒ ÛŒÚ© Node Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Node Properties Templates -->
    <template id="textInputProperties">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØ±ÙˆØ¯ÛŒ">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶</label>
                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ</label>
                <select class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="none">Ø¨Ø¯ÙˆÙ† Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ</option>
                    <option value="required">Ø§Ø¬Ø¨Ø§Ø±ÛŒ</option>
                    <option value="email">Ø§ÛŒÙ…ÛŒÙ„</option>
                    <option value="phone">ØªÙ„ÙÙ†</option>
                </select>
            </div>
        </div>
    </template>

    <template id="gptProcessorProperties">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ø¯Ù„</label>
                <select class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                <textarea class="w-full p-2 border border-gray-300 rounded-lg h-24" placeholder="Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø±Ø§ÛŒ AI"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Temperature</label>
                <input type="range" min="0" max="1" step="0.1" class="w-full">
                <span class="text-sm text-gray-600">0.7</span>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Max Tokens</label>
                <input type="number" class="w-full p-2 border border-gray-300 rounded-lg" value="1000">
            </div>
        </div>
    </template>

    <template id="apiCallProperties">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                <input type="url" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="https://api.example.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Method</label>
                <select class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Headers</label>
                <textarea class="w-full p-2 border border-gray-300 rounded-lg h-20" placeholder='{"Authorization": "Bearer token"}'></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Body</label>
                <textarea class="w-full p-2 border border-gray-300 rounded-lg h-20" placeholder='{"key": "value"}'></textarea>
            </div>
        </div>
    </template>

    <!-- Test Panel Modal -->
    <div id="testPanel" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">ğŸ§ª ØªØ³Øª Agent</h3>
                        <button onclick="closeTestPanel()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÙˆØ±ÙˆØ¯ÛŒ ØªØ³Øª</label>
                            <textarea id="testInput" class="w-full p-3 border border-gray-300 rounded-lg h-24" placeholder="Ù…ØªÙ† ØªØ³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                        </div>
                        <button onclick="runTest()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-all">
                            <i class="fas fa-play"></i>
                            Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª
                        </button>
                        <div id="testResults" class="hidden">
                            <h4 class="font-semibold mb-2">Ù†ØªØ§ÛŒØ¬ ØªØ³Øª:</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <pre id="testOutput" class="text-sm"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let stage, layer;
        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let isConnecting = false;
        let connectionStart = null;
        let nodeIdCounter = 0;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            initializeEventListeners();
            loadSampleAgent();
        });

        function initializeCanvas() {
            const container = document.getElementById('workflowCanvas');
            const width = container.offsetWidth;
            const height = container.offsetHeight;

            stage = new Konva.Stage({
                container: 'workflowCanvas',
                width: width,
                height: height,
                draggable: true
            });

            layer = new Konva.Layer();
            stage.add(layer);

            // Handle window resize
            window.addEventListener('resize', () => {
                const newWidth = container.offsetWidth;
                const newHeight = container.offsetHeight;
                stage.width(newWidth);
                stage.height(newHeight);
            });
        }

        function initializeEventListeners() {
            // Drag and drop from sidebar
            const nodeCards = document.querySelectorAll('.node-card');
            nodeCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
            });

            // Canvas drop
            stage.on('drop', handleDrop);
            stage.on('dragover', handleDragOver);

            // Node interactions
            stage.on('click tap', handleCanvasClick);
            stage.on('dragend', handleNodeDragEnd);

            // Toolbar buttons
            document.getElementById('saveAgent').addEventListener('click', saveAgent);
            document.getElementById('runAgent').addEventListener('click', runAgent);
            document.getElementById('testAgent').addEventListener('click', openTestPanel);
            document.getElementById('zoomIn').addEventListener('click', () => zoom(1.2));
            document.getElementById('zoomOut').addEventListener('click', () => zoom(0.8));
            document.getElementById('centerView').addEventListener('click', centerView);
        }

        function handleDragStart(e) {
            const nodeType = e.target.getAttribute('data-node-type');
            e.dataTransfer.setData('text/plain', nodeType);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const nodeType = e.dataTransfer.getData('text/plain');
            const pos = stage.getPointerPosition();
            createNode(nodeType, pos.x, pos.y);
        }

        function createNode(type, x, y) {
            const nodeId = `node_${++nodeIdCounter}`;
            const nodeConfig = getNodeConfig(type);
            
            // Create node group
            const group = new Konva.Group({
                x: x,
                y: y,
                draggable: true,
                id: nodeId
            });

            // Background
            const rect = new Konva.Rect({
                width: nodeConfig.width,
                height: nodeConfig.height,
                fill: nodeConfig.color,
                stroke: '#374151',
                strokeWidth: 2,
                cornerRadius: 8
            });

            // Icon
            const icon = new Konva.Text({
                text: nodeConfig.icon,
                fontSize: 20,
                fill: 'white',
                x: 15,
                y: 15,
                width: 30,
                height: 30,
                align: 'center',
                verticalAlign: 'middle'
            });

            // Title
            const title = new Konva.Text({
                text: nodeConfig.title,
                fontSize: 14,
                fontStyle: 'bold',
                fill: 'white',
                x: 50,
                y: 15,
                width: nodeConfig.width - 60,
                height: 20
            });

            // Description
            const description = new Konva.Text({
                text: nodeConfig.description,
                fontSize: 10,
                fill: 'white',
                x: 50,
                y: 35,
                width: nodeConfig.width - 60,
                height: 30
            });

            // Input connector
            const inputConnector = new Konva.Circle({
                x: 0,
                y: nodeConfig.height / 2,
                radius: 6,
                fill: '#10b981',
                stroke: 'white',
                strokeWidth: 2
            });

            // Output connector
            const outputConnector = new Konva.Circle({
                x: nodeConfig.width,
                y: nodeConfig.height / 2,
                radius: 6,
                fill: '#ef4444',
                stroke: 'white',
                strokeWidth: 2
            });

            group.add(rect);
            group.add(icon);
            group.add(title);
            group.add(description);
            group.add(inputConnector);
            group.add(outputConnector);

            // Add click handler
            group.on('click tap', () => selectNode(nodeId, type));

            layer.add(group);
            layer.draw();

            // Store node data
            nodes.push({
                id: nodeId,
                type: type,
                group: group,
                config: nodeConfig
            });
        }

        function getNodeConfig(type) {
            const configs = {
                'text-input': {
                    title: 'ÙˆØ±ÙˆØ¯ÛŒ Ù…ØªÙ†',
                    description: 'Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø§Ø² Ú©Ø§Ø±Ø¨Ø±',
                    icon: 'âŒ¨ï¸',
                    color: '#10b981',
                    width: 200,
                    height: 80
                },
                'voice-input': {
                    title: 'ÙˆØ±ÙˆØ¯ÛŒ ØµØ¯Ø§',
                    description: 'ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø±',
                    icon: 'ğŸ¤',
                    color: '#10b981',
                    width: 200,
                    height: 80
                },
                'gpt-processor': {
                    title: 'GPT Processor',
                    description: 'Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ GPT-4',
                    icon: 'ğŸ¤–',
                    color: '#8b5cf6',
                    width: 200,
                    height: 80
                },
                'api-call': {
                    title: 'ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API',
                    description: 'Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª HTTP',
                    icon: 'ğŸŒ',
                    color: '#f59e0b',
                    width: 200,
                    height: 80
                },
                'database-save': {
                    title: 'Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³',
                    description: 'Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª',
                    icon: 'ğŸ’¾',
                    color: '#f59e0b',
                    width: 200,
                    height: 80
                },
                'condition': {
                    title: 'Ø´Ø±Ø·',
                    description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø·',
                    icon: 'â“',
                    color: '#3b82f6',
                    width: 200,
                    height: 80
                },
                'text-output': {
                    title: 'Ø®Ø±ÙˆØ¬ÛŒ Ù…ØªÙ†',
                    description: 'Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ†',
                    icon: 'ğŸ’¬',
                    color: '#ef4444',
                    width: 200,
                    height: 80
                }
            };
            return configs[type] || configs['text-input'];
        }

        function selectNode(nodeId, type) {
            // Deselect previous node
            if (selectedNode) {
                const prevNode = nodes.find(n => n.id === selectedNode);
                if (prevNode) {
                    prevNode.group.stroke('#374151');
                    prevNode.group.strokeWidth(2);
                }
            }

            // Select new node
            const node = nodes.find(n => n.id === nodeId);
            if (node) {
                node.group.stroke('#3b82f6');
                node.group.strokeWidth(3);
                selectedNode = nodeId;
                showNodeProperties(type);
            }

            layer.draw();
        }

        function showNodeProperties(type) {
            const propertiesPanel = document.getElementById('nodeProperties');
            const template = document.getElementById(`${type.replace('-', '')}Properties`);
            
            if (template) {
                propertiesPanel.innerHTML = template.innerHTML;
            } else {
                propertiesPanel.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ù†Ø§Ù… Node</label>
                            <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ù†Ø§Ù… Node">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                            <textarea class="w-full p-2 border border-gray-300 rounded-lg h-20" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Node"></textarea>
                        </div>
                    </div>
                `;
            }
        }

        function handleCanvasClick(e) {
            if (e.target === stage) {
                // Deselect all nodes
                nodes.forEach(node => {
                    node.group.stroke('#374151');
                    node.group.strokeWidth(2);
                });
                selectedNode = null;
                document.getElementById('nodeProperties').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                        <p>Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ Ø±ÙˆÛŒ ÛŒÚ© Node Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
                    </div>
                `;
                layer.draw();
            }
        }

        function handleNodeDragEnd(e) {
            // Update connections when node moves
            updateConnections();
        }

        function updateConnections() {
            // Clear existing connections
            const svg = document.getElementById('connectionLines');
            svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" /></marker></defs>';
            
            // Redraw connections
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                
                if (fromNode && toNode) {
                    const fromPos = fromNode.group.position();
                    const toPos = toNode.group.position();
                    
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', fromPos.x + 200);
                    line.setAttribute('y1', fromPos.y + 40);
                    line.setAttribute('x2', toPos.x);
                    line.setAttribute('y2', toPos.y + 40);
                    line.setAttribute('class', 'connection-line');
                    
                    svg.appendChild(line);
                }
            });
        }

        function zoom(factor) {
            const oldScale = stage.scaleX();
            const newScale = oldScale * factor;
            stage.scale({ x: newScale, y: newScale });
            layer.draw();
        }

        function centerView() {
            stage.position({ x: 0, y: 0 });
            stage.scale({ x: 1, y: 1 });
            layer.draw();
        }

        function saveAgent() {
            const agentData = {
                name: document.getElementById('agentName').textContent,
                nodes: nodes.map(node => ({
                    id: node.id,
                    type: node.type,
                    x: node.group.x(),
                    y: node.group.y()
                })),
                connections: connections,
                created_at: new Date().toISOString()
            };
            
            // Save to localStorage for demo
            localStorage.setItem('currentAgent', JSON.stringify(agentData));
            
            alert('âœ… Agent Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
        }

        function runAgent() {
            if (nodes.length === 0) {
                alert('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Node Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ Canvas Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            // Simulate agent execution
            alert('ğŸš€ Agent Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª...');
            
            // Show execution flow
            setTimeout(() => {
                alert('âœ… Agent Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯!');
            }, 2000);
        }

        function openTestPanel() {
            document.getElementById('testPanel').classList.remove('hidden');
        }

        function closeTestPanel() {
            document.getElementById('testPanel').classList.add('hidden');
        }

        function runTest() {
            const testInput = document.getElementById('testInput').value;
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');
            
            if (!testInput.trim()) {
                alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙˆØ±ÙˆØ¯ÛŒ ØªØ³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            // Simulate test execution
            testOutput.textContent = `ÙˆØ±ÙˆØ¯ÛŒ: ${testInput}\n\nÙ†ØªÛŒØ¬Ù‡: Agent Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯!\n\nØ®Ø±ÙˆØ¬ÛŒ: Ù¾Ø§Ø³Ø® ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· AI`;
            testResults.classList.remove('hidden');
        }

        function loadSampleAgent() {
            // Load sample agent from localStorage if exists
            const savedAgent = localStorage.getItem('currentAgent');
            if (savedAgent) {
                const agentData = JSON.parse(savedAgent);
                document.getElementById('agentName').textContent = agentData.name;
                
                // Recreate nodes
                agentData.nodes.forEach(nodeData => {
                    createNode(nodeData.type, nodeData.x, nodeData.y);
                });
                
                // Recreate connections
                connections = agentData.connections || [];
                updateConnections();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveAgent();
                        break;
                    case 'r':
                        e.preventDefault();
                        runAgent();
                        break;
                    case 't':
                        e.preventDefault();
                        openTestPanel();
                        break;
                }
            }
            
            if (e.key === 'Delete' && selectedNode) {
                // Delete selected node
                const nodeIndex = nodes.findIndex(n => n.id === selectedNode);
                if (nodeIndex !== -1) {
                    nodes[nodeIndex].group.destroy();
                    nodes.splice(nodeIndex, 1);
                    selectedNode = null;
                    layer.draw();
                }
            }
        });
    </script>
</body>
</html>
