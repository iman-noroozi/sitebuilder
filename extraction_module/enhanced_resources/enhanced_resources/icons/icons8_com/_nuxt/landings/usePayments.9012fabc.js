import{f as Z,a0 as z,l as $,a1 as we,J as Se,a2 as Le,u as ke,L as Te,a3 as Re}from"./entry.e76eb76a.js";import{o as He}from"./helper.016738b8.js";import{u as ee,c as Ce,d as B,e as Ie,f as xe,h as _e,j as Ae,k as Fe,i as L,g as Q,l as Oe,m as qe,n as Me,s as De,o as Ee,p as Ge}from"./index.52dd45d9.js";import{m as N,n as Ne}from"./libs.b22191e3.js";import{r as P,c as l,w as U,a3 as Ue}from"./vue.178cf25e.js";import"./index.4b7d8a63.js";import"./dayjs.min.3b0842e9.js";function Ke(s,a,c,t){var n;window.gtag&&window.gtag("event","add_payment_info",{currency:s.amount.currency,value:s.amount.value,payment_type:a,items:[{item_name:s.alias,item_brand:"icons8",item_category:c,item_variant:((n=s.recurringFrequency)==null?void 0:n.toLowerCase())||t,price:s.amount.value,currency:s.amount.currency,quantity:1}]})}function We(s){return s.products.reduce((a,c)=>[...c.allowances.map(n=>n.resource),...a],[])}function je(s){return s.reduce((a,c)=>[...a,...We(c)],[])}function K(s){return s.reduce((a,c)=>{const t=c.allowances?c.allowances.map(n=>n.resource):[];return[...a,...t]},[])}function X(s){var p;const{licenses:a,products:c,productsData:t}=s,n=[];if(!c.length)return n;const o=a.filter(u=>u.status==="active"),e=o.map(u=>u.period),i=c.map(u=>u.recurringFrequency),d=new Set([...e,...i]),m=Object.entries(t).filter(([u,h])=>typeof h=="object").filter(([u,h])=>h.resourceTypes.length>1).sort((u,h)=>u[1].resourceTypes.length-h[1].resourceTypes.length).map(([u])=>u);for(const u of d){const h=o.filter(T=>T.period===u),k=c.filter(T=>T.recurringFrequency===u),A=new Set([...je(h),...K(k)]);let y=[...k];for(const T of m){const R=T,b=t[R],v=N([...A],b.resourceTypes),F=b.resourceTypes.some(O=>K(k).includes(O));if(v&&F){y=y.filter(M=>{const q=M.allowances.map(x=>x.resource);return!M.allowances.length||!N(b.resourceTypes,q)});const O=u.toLowerCase(),I=(p=b[O])==null?void 0:p[0];I&&y.push({productKey:R,...I})}}n.push(...y)}return n}function ss(s,a){const c=[],t=a.filter(i=>i.status==="active"),n=t.map(i=>i.period),o=s.map(i=>i.recurringFrequency),e=new Set([...n,...o]);for(const i of e){const d=t.filter(u=>u.period===i),m=s.filter(u=>u.recurringFrequency===i),p=K(m);d.forEach(u=>{u==null||u.products.forEach(h=>{const k=h.allowances.map(A=>A.resource);N(p,k)&&c.push(h)})})}return c}const Ve=Z("subscribe",()=>{const s=P([]),a=P([]),c=ee(),t=W(),n=l(()=>X({productsData:c.products,licenses:t.licenses,products:s.value})),o=l(()=>X({productsData:c.products,licenses:t.licenses,products:[...s.value,...a.value]}));function e(p){s.value=[...s.value,...p]}function i(){s.value=[]}function d(p){a.value=[...a.value,...p]}function m(p){a.value=a.value.filter(u=>!p.some(h=>u.alias===h.alias))}return{validProductsToSubscribe:n,productsToSubscribe:s,validProducts:o,addProductsToSubscribe:e,clearProductsToSubscribe:i,addProductsInProcess:d,removeProductsInProcess:m}}),W=Z("payments",()=>{const s=P([]),a=P(!1);async function c(){try{a.value=!0;const e=await z();console.log(e),e.data.docs&&(s.value=e.data.docs)}catch(e){console.error("Failed to fetch subscriptions.",e)}finally{a.value=!1}}async function t(e={}){e.delay??(e.delay=1500),e.iterations??(e.iterations=5),!e.immediate&&await Ne(e.delay);try{const d=(await z()).data.docs;return e.iterations&&!Ce(d)?t({...e,immediate:!1,recursive:!0,iterations:e.iterations-1}):(e.beforeUpdate&&await e.beforeUpdate(),s.value=d,{success:e.iterations>0,recursive:!!e.recursive})}catch(i){return console.error("Failed to update subscriptions.",i),{success:!1,recursive:!!e.recursive}}}function n(e){a.value=e}function o(){s.value=[]}return{licenses:s,loadingLicenses:a,fetchLicenses:c,updateLicenses:t,changeLoading:n,clearLicences:o}});function Je(s){const a=P(0),c=P([]);return{nextHandler:()=>{if(a.value<s.length){const o=s[a.value];c.value.push(o.name),a.value+=1,o.handle()}},resetChain:()=>{a.value=0,c.value=[]},history:c}}function Ye(){const s=P({type:null,data:null});function a(c,t){s.value={type:c,data:t},c==="auth"&&He({popupSource:"pricing"})}return{modal:s,changeModal:a}}function ts(){const s=P(!1),a=P(!1),c=Se(),t=$(),n=W(),o=l(()=>t.user),e=l(()=>t.user.id);return we(c.public.reCaptchaSiteKey),U(e,async()=>{if(s.value=!o.value.loaded,a.value=!0,n.changeLoading(!0),!!o.value.loaded){if(!o.value.isGuest){const{success:d,recursive:m}=await n.updateLicenses({immediate:!0});d&&m&&await t.fillUserInfo()}a.value=!1,n.changeLoading(!1)}},{immediate:!0}),U(o,()=>{o.value.loaded&&(s.value=!1,o.value.isGuest&&n.changeLoading(!1))}),{isInitLoading:a,isAuthLoading:s}}function as(s){const{$growthbook:a,$region:c}=ke(),{productKey:t,period:n}=s,{modal:o,changeModal:e}=Ye(),i=P(!1),d=P(),m=P(),p=W(),u=ee(),h=Ve(),k=$(),A=l(()=>p.loadingLicenses),y=l(()=>p.licenses),T=l(()=>k.user.isGuest),R=l(()=>u.products),b=l(()=>R.value[t][n.value][0]),v=l(()=>B(y.value,n.value)),F=l(()=>{var r;return(r=R.value[t].oneTime)==null?void 0:r[0]}),O=l(()=>{var r;return(r=v.value)==null?void 0:r.allowResume}),I=l(()=>Ie(y.value)),M=l(()=>xe(t)),q=l(()=>_e(t)),x=l(()=>Ae(t)),se=l(()=>!!F.value),te=l(()=>{var r,g;return(g=(r=v.value)==null?void 0:r.products)==null?void 0:g.length}),E=l(()=>v.value&&!x.value&&!q.value&&Fe({licenses:y.value,license:v.value,product:b.value})),G=l(()=>{var r;return E.value&&((r=v.value)==null?void 0:r.status)==="paused"}),j=async()=>{v.value&&(p.changeLoading(!0),await Le({subscriptionId:v.value.id}),await p.updateLicenses(),p.changeLoading(!1))},ae=(r,g)=>r==="wechat"&&F.value?F.value:Ee(g||b.value,R.value,v.value),re=async()=>{Q()==="pricing"?Te().push(Ge(t)):(e("status",{status:"payment-success"}),p.changeLoading(!0),await p.updateLicenses(),p.changeLoading(!1))},V=r=>new Promise((g,S)=>{setTimeout(async()=>{const w=((await Re()).docs||[]).find(_=>_.orderId===r);w?(w.status==="created"&&V(r),w.status==="paid"&&(e("status",{status:"payment-success"}),g()),w.status==="cancelled"&&(e("status",{status:"payment-cancelled"}),g())):(console.error("Not found order for WeChat"),e("status",{status:"payment-error"}),S())},5e3)}),D=async(r,g)=>{i.value=!0;const S=ae(r,g),H=v.value?Me(S,v.value):[],C={provider:r,productKey:t,period:n.value,product:S,isUpgrade:!!H.length};L.track("payment",C),Ke(S,r,t,n.value),r==="wechat"&&e(null);const w=await De(S,r,H,{recaptchaToken:c!=null&&c.isChinaRegion.value?"fake-china-recaptcha-token":void 0});if(w.success){const{id:_,actions:Y}=w;r==="wechat"&&_&&await V(_),Y&&!Y.length&&(L.track("paymentSuccess",C),re())}w.success||(L.track("paymentError",C),e("status",{status:"payment-error"}),console.error(w.message)),i.value=!1},ce={name:"init",handle:()=>{d.value=void 0,m.value=void 0,L.track("subscribeClick",{productKey:t,period:n.value}),f()}},ne={name:"pause",handle:()=>{G.value?j():f()}},ue={name:"resume",handle:()=>{var r;((r=v.value)==null?void 0:r.status)==="paused"?e("resume"):f()}},oe={name:"trial",handle:()=>{x.value?(e("trial",{licenses:y.value}),L.track("subscribeTrial",{productKey:t,period:n.value})):f()}},ie={name:"special",handle:()=>{q.value&&!x.value?(e("special",{licenses:y.value}),L.track("subscribeSpecial",{productKey:t,period:n.value})):f()}},le={name:"to-subscribe",handle:()=>{var S;const r=Q()==="profile",g=(S=m.value)==null?void 0:S.trial;if(r&&I.value&&!g){const H=m.value||b.value,C=H.recurringFrequency.toLowerCase();if(B(y.value,C)){e(null),Ue(()=>{const _={productKey:t,...H};h.addProductsToSubscribe([_])}),L.track("toSubscribe",{productKey:t,period:C,product:H});return}}f()}},de={name:"payment-direct",handle:()=>{d.value&&m.value?D(d.value,m.value):f()}},pe={name:"upgrade",handle:()=>{v.value&&te.value?(e("upgrade",{currentPrice:Oe(v.value),newPrice:qe(b.value,v.value),provider:I.value?"stripe":"paypal"}),L.track("subscribeUpgrade",{productKey:t,period:n.value})):f()}},ve={name:"payment-stripe",handle:()=>{I.value||M.value?D("stripe"):f()}},fe={name:"stripe-experiment",handle:()=>{a(r=>{r.isOn("STRIPE_PAYMENT")?D("stripe"):f()})}},me={name:"payment-method",handle:()=>{d.value?f():(e("methods",{hasWechat:se.value}),L.track("subscribeMethods",{productKey:t,period:n.value}))}},he={name:"auth",handle:()=>{T.value&&d.value!=="stripe"?e("auth"):f()}},ye={name:"payment",handle:()=>{d.value&&D(d.value)}},{nextHandler:f,resetChain:ge}=Je([ce,ne,ue,oe,ie,le,de,pe,ve,fe,me,he,ye]),J=()=>{ge(),f()},Pe=(r,g)=>{d.value=r,m.value=g,f()},be=async()=>{await j(),J()};return U([y],()=>{var r;((r=o.value)==null?void 0:r.type)!=="auth"||!y.value||(!G.value&&!E.value?f():e("status",{status:"payment-exist"}))}),{modal:o,product:b,licenses:y,products:R,hasTrial:x,isPaused:G,isSpecial:q,isSubscribed:E,isResumeAllowed:O,isLoadingPayment:i,isLoadingLicenses:A,changeModal:e,onSubscribe:J,onCheckout:Pe,onResume:be}}export{Ve as a,X as b,ts as c,as as d,ss as g,W as u};
