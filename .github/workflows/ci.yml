name: ðŸš€ PEY Builder CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ðŸ§ª ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Python
  test-python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.11]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ðŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
      run: |
        python -m pytest tests/test_basic.py -v --tb=short
    
    - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
      run: |
        python -m pytest tests/test_advanced_features.py -v --tb=short
    
    - name: ðŸ”’ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
      run: |
        python -m pytest tests/test_security.py -v --tb=short
    
    - name: âš¡ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
      run: |
        python -m pytest tests/test_performance.py -v --tb=short
    
    - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Django (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯)
      run: |
        if [ -d "backend" ]; then
          cd backend
          python manage.py check || echo "Django tests skipped"
          cd ..
        fi
      continue-on-error: true

  # ðŸ§ª ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Node.js
  test-node:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ðŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      run: npm ci
    
    - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Jest
      run: npm test -- --coverage --verbose
    
    - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Node.js
      run: node tests/test_node_comprehensive.js
    
    - name: ðŸ” Ø§Ø¬Ø±Ø§ÛŒ ESLint
      run: npm run lint || echo "ESLint skipped"
      continue-on-error: true
    
    - name: ðŸŽ¨ Ø§Ø¬Ø±Ø§ÛŒ Prettier
      run: npm run format:check || echo "Prettier check skipped"
      continue-on-error: true

  # ðŸ”’ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        pip install bandit safety semgrep
    
    - name: ðŸ” ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§ Bandit
      run: |
        bandit -r . -f json -o bandit-report.json || echo "Bandit check completed"
        bandit -r . -f txt -o bandit-report.txt || echo "Bandit text report completed"
      continue-on-error: true
    
    - name: ðŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ø§Ù…Ù†
      run: |
        safety check --json --output safety-report.json || echo "Safety check completed"
        safety check --output safety-report.txt || echo "Safety text report completed"
      continue-on-error: true
    
    - name: ðŸ” ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§ Semgrep
      run: |
        semgrep --config=auto --json --output=semgrep-report.json . || echo "Semgrep check completed"
      continue-on-error: true
    
    - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ø³ÙØ§Ø±Ø´ÛŒ
      run: |
        python -m pytest tests/test_security.py -v --tb=short
      continue-on-error: true
    
    - name: ðŸ“Š Ø¢Ù¾Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ù†ÛŒØªÛŒ
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          bandit-report.txt
          safety-report.json
          safety-report.txt
          semgrep-report.json
      continue-on-error: true

  # ðŸ—ï¸ Build Ùˆ Deploy
  build:
    needs: [test-python, test-node, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸŸ¢ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ðŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        npm ci
    
    - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
      run: |
        python -m pytest tests/ -v --tb=short
        npm test
    
    - name: ðŸ³ Build Docker Image
      run: |
        docker build -t pey-builder:latest .
        docker tag pey-builder:latest pey-builder:${{ github.sha }}
    
    - name: ðŸš€ Deploy to Production
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸš€ Deploying PEY Builder to production..."
        echo "âœ… All tests passed successfully!"
        echo "ðŸ³ Docker image built: pey-builder:${{ github.sha }}"
        # Ø§ÛŒÙ†Ø¬Ø§ Ø¯Ø³ØªÙˆØ±Ø§Øª deployment ÙˆØ§Ù‚Ø¹ÛŒ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯

  # ðŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ
  report:
    needs: [test-python, test-node, security, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹
      run: |
        echo "## ðŸš€ PEY Builder - Ú¯Ø²Ø§Ø±Ø´ CI/CD" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ§ª Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Python: ${{ needs.test-python.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŸ¢ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Node.js: ${{ needs.test-node.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Ø¢Ù…Ø§Ø± Ù¾Ø±ÙˆÚ˜Ù‡" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡: PEY Builder" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ Ø¯Ø§Ù…Ù†Ù‡: peyai.ir" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“… ØªØ§Ø±ÛŒØ®: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.test-python.result }}" == "success" && "${{ needs.test-node.result }}" == "success" && "${{ needs.security.result }}" == "success" ]]; then
          echo "ðŸŽ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Ø¨Ø±Ø®ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯" >> $GITHUB_STEP_SUMMARY
        fi