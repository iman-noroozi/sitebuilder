name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ðŸ§ª ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Python
  test-python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.11]

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ðŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install -r requirements-test.txt

      - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
        run: |
          python -m pytest tests/test_basic.py -v

      - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
        run: |
          python -m pytest tests/test_security.py -v

      - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Django (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯)
        run: |
          cd backend
          python manage.py check || echo "Django tests skipped"
          cd ..
        continue-on-error: true

  # ðŸ§ª ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Node.js
  test-node:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - uses: actions/checkout@v3

      - name: ðŸŸ¢ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
        run: npm install

      - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡
        run: npm test

      - name: ðŸ” Ø§Ø¬Ø±Ø§ÛŒ ESLint
        run: npm run lint || echo "ESLint skipped"
        continue-on-error: true

  # ðŸ”’ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
  security:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: ðŸ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install -r requirements-test.txt
          pip install bandit safety

      - name: ðŸ” ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§ Bandit
        run: bandit -r backend/ -f json -o bandit-report.json || echo "Bandit check completed"
        continue-on-error: true

      - name: ðŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ø§Ù…Ù†
        run: safety check --json --output safety-report.json || echo "Safety check completed"
        continue-on-error: true

      - name: ðŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ø³ÙØ§Ø±Ø´ÛŒ
        run: |
          python -m pytest tests/test_security.py -v

      - name: ðŸ“Š Ø¢Ù¾Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ù†ÛŒØªÛŒ
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
        continue-on-error: true

  # ðŸ—ï¸ Build Ùˆ Deploy
  build:
    needs: [test-python, test-node, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: ðŸ³ Build Docker Image
        run: |
          docker build -t sitebuilder:latest .
          docker tag sitebuilder:latest sitebuilder:${{ github.sha }}

      - name: ðŸš€ Deploy to Production
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸš€ Deploying to production..."
          # Ø§ÛŒÙ†Ø¬Ø§ Ø¯Ø³ØªÙˆØ±Ø§Øª deployment ÙˆØ§Ù‚Ø¹ÛŒ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯

  # ðŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ
  report:
    needs: [test-python, test-node, security]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ“Š Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø²Ø§Ø±Ø´
        run: |
          echo "## ðŸ§ª Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Python: ${{ needs.test-python.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Node.js: ${{ needs.test-node.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
